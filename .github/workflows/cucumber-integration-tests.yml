name: Cucumber Integration Tests

on:
  pull_request:
    branches:
      - main

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Update integration test application properties
        run: |
          sed -i 's/LogTestRail=false/LogTestRail=true/g' onadata/integration-tests/src/test/resources/application.properties
          sed -i 's/baseUrl=<onadata_baseUrl>/baseUrl='$(echo $BASE_URL)'/g' onadata/integration-tests/src/test/resources/application.properties
          sed -i 's/TestRailusername=<testrail_username>/TestRailusername='$(echo $TEST_RAIL_USERNAME)'/g' onadata/integration-tests/src/test/resources/application.properties
          sed -i 's/TestRailpassword=<testrail_password>/TestRailpassword='$(echo $TEST_RAIL_PASSWORD)'/g' onadata/integration-tests/src/test/resources/application.properties
          sed -i 's/TestRailurl=<testrail_url>/TestRailurl='$(echo $TEST_RAIL_URL)'/g' onadata/integration-tests/src/test/resources/application.properties
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          TEST_RAIL_USERNAME: ${{ secrets.TEST_RAIL_USERNAME }}
          TEST_RAIL_PASSWORD: ${{ secrets.TEST_RAIL_PASSWORD }}
          TEST_RAIL_URL: ${{ secrets.TEST_RAIL_URL }}


      - name: Wait (max 5 mins) for onadata server to be reachable
        run: |
          count=0; while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' baseUrl/status)" != "200" ]]; do if [[ count -lt 120 ]]; then ((count=count+1)); else exit 1; fi; sleep 5; done

      - name: Run integration tests
        run: mvn -f onadata/integration-tests/ clean test
